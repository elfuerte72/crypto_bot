# TASK-009: Команда /set_markup - Документация

## Обзор задачи

**Задача**: Реализация административной команды `/set_markup` для управления наценками валютных пар
**Статус**: ✅ ВЫПОЛНЕНО
**Время выполнения**: 3 часа
**Приоритет**: Высокий
**Фаза проекта**: Фаза 4 (Административные функции)

## Описание функциональности

Команда `/set_markup` предоставляет администраторам возможность динамически изменять процентные наценки для всех поддерживаемых валютных пар. Это ключевая функция для управления прибыльностью обменных операций и адаптации к изменяющимся рыночным условиям.

## Бизнес-требования

### Основные возможности
- **Просмотр текущих наценок**: Отображение всех валютных пар с актуальными процентными наценками
- **Изменение наценок**: Возможность установки новых значений наценки для любой валютной пары
- **Создание новых пар**: Автоматическое создание конфигурации при установке наценки для несуществующей пары
- **Валидация данных**: Строгая проверка введенных значений на соответствие бизнес-правилам
- **Немедленное применение**: Мгновенное вступление изменений в силу без перезапуска системы

### Ограничения доступа
- **Только для администраторов**: Команда доступна исключительно пользователям из списка `admin_user_ids`
- **Проверка прав**: Автоматическая верификация прав доступа на каждом этапе взаимодействия
- **Безопасность**: Защита от несанкционированного доступа с информативными сообщениями об отказе

## Техническая архитектура

### Компоненты системы

#### AdminService
Центральный сервис для всех административных операций:
- **Проверка прав доступа**: Верификация статуса администратора по Telegram ID
- **Управление наценками**: CRUD операции с конфигурацией валютных пар
- **Форматирование сообщений**: Создание пользовательских интерфейсов для отображения данных
- **Валидация бизнес-правил**: Проверка корректности вводимых значений

#### FSM (Finite State Machine)
Управление состояниями пользовательского взаимодействия:
- **AdminStates.waiting_for_markup_value**: Состояние ожидания ввода процента наценки
- **Сохранение контекста**: Временное хранение данных о выбранной валютной паре
- **Обработка ошибок**: Корректное завершение сессий при возникновении проблем

#### Inline клавиатуры
Интерактивный пользовательский интерфейс:
- **Список валютных пар**: Отображение всех доступных пар с текущими наценками
- **Навигация**: Кнопки для перехода между экранами
- **Мобильная оптимизация**: 2-колоночная раскладка для удобства использования

### Поток взаимодействия

#### Этап 1: Инициация команды
1. Администратор отправляет команду `/set_markup`
2. Система проверяет права доступа пользователя
3. При успешной авторизации отображается список валютных пар с текущими наценками
4. При отсутствии прав выводится сообщение об отказе в доступе

#### Этап 2: Выбор валютной пары
1. Администратор выбирает интересующую валютную пару из inline клавиатуры
2. Система сохраняет выбор в FSM контексте
3. Отображается текущая наценка и запрос на ввод нового значения
4. Активируется состояние ожидания пользовательского ввода

#### Этап 3: Ввод нового значения
1. Администратор вводит новый процент наценки в текстовом сообщении
2. Система выполняет валидацию формата и диапазона значений
3. При корректном вводе происходит обновление конфигурации
4. Отображается подтверждение изменений и обновленный список наценок

#### Этап 4: Завершение операции
1. FSM состояние очищается
2. Администратор может продолжить работу с другими валютными парами
3. Все изменения немедленно доступны в других компонентах системы

## Валидация и обработка ошибок

### Проверка прав доступа
- **Уровень команды**: Проверка при вызове `/set_markup`
- **Уровень callback**: Верификация при выборе валютной пары
- **Уровень ввода**: Контроль при вводе значений наценки
- **Уровень навигации**: Проверка при использовании кнопок управления

### Валидация данных
- **Формат числа**: Поддержка целых и десятичных чисел с точкой или запятой
- **Диапазон значений**: Строгое ограничение от 0% до 100%
- **Regex проверка**: Использование регулярных выражений для валидации формата
- **Обработка исключений**: Корректная обработка некорректного ввода

### Сценарии ошибок
- **Неавторизованный доступ**: Информативное сообщение о недостатке прав
- **Неверный формат**: Подсказки по корректному вводу с примерами
- **Значение вне диапазона**: Указание допустимых границ значений
- **Потеря сессии**: Предложение начать процедуру заново
- **Системные ошибки**: Общие сообщения с рекомендацией обратиться к разработчику

## Интеграция с системой

### Конфигурационные модели
- **Settings.currency_pairs**: Основное хранилище конфигурации валютных пар
- **CurrencyPair.markup_rate**: Поле для хранения процента наценки
- **Settings.default_markup_rate**: Значение по умолчанию для новых пар

### Зависимости компонентов
- **Configuration Service**: Управление настройками приложения
- **Currency Keyboard**: Генерация интерактивных интерфейсов
- **FSM States**: Управление состояниями пользовательских сессий
- **Admin Authorization**: Система проверки административных прав

### Влияние на другие модули
- **Rate Handler**: Использует обновленные наценки для расчета курсов
- **Calculation Service**: Применяет актуальные проценты в расчетах
- **Notification Service**: Может уведомлять о изменениях наценок

## Пользовательский опыт

### Интерфейс администратора
- **Интуитивная навигация**: Логичная последовательность экранов
- **Визуальная обратная связь**: Эмодзи и форматирование для улучшения восприятия
- **Информативные сообщения**: Подробные описания текущего состояния
- **Быстрый доступ**: Минимальное количество шагов для выполнения операций

### Обработка пользовательских ошибок
- **Превентивные меры**: Валидация на каждом этапе ввода
- **Понятные сообщения**: Объяснение причин ошибок и способов их устранения
- **Возможность повтора**: Сохранение контекста при некорректном вводе
- **Graceful degradation**: Корректное завершение сессий при критических ошибках

## Безопасность и надежность

### Контроль доступа
- **Многоуровневая проверка**: Верификация прав на каждом этапе взаимодействия
- **Защита от подделки**: Проверка подлинности пользовательских запросов
- **Логирование действий**: Фиксация всех административных операций
- **Изоляция функций**: Разделение административных и пользовательских возможностей

### Надежность системы
- **Атомарность операций**: Целостность данных при обновлении конфигурации
- **Обработка исключений**: Корректная реакция на непредвиденные ситуации
- **Восстановление состояния**: Возможность продолжения работы после ошибок
- **Мониторинг операций**: Отслеживание успешности выполнения команд

## Тестирование и качество

### Покрытие тестами
- **Unit тесты**: 31 тест покрывающий все компоненты функциональности
- **Тестирование сервисов**: Проверка логики AdminService
- **Тестирование интерфейсов**: Валидация обработчиков команд и callback'ов
- **Тестирование авторизации**: Проверка работы системы контроля доступа
- **Тестирование FSM**: Верификация корректности переходов между состояниями

### Качество кода
- **Типизация**: Полная поддержка type hints для всех функций
- **Документация**: Подробные docstring для всех публичных методов
- **Соответствие стандартам**: Следование принципам clean code
- **Модульность**: Четкое разделение ответственности между компонентами

## Метрики производительности

### Время отклика
- **Отображение списка**: Мгновенная генерация интерфейса выбора
- **Обновление конфигурации**: Немедленное применение изменений
- **Валидация данных**: Быстрая проверка пользовательского ввода
- **Навигация**: Отзывчивое переключение между экранами

### Использование ресурсов
- **Память**: Минимальное потребление благодаря singleton паттерну
- **Сеть**: Эффективное использование Telegram API
- **Процессор**: Оптимизированные алгоритмы валидации и обработки

## Мониторинг и логирование

### Отслеживание операций
- **Команды администратора**: Фиксация всех вызовов `/set_markup`
- **Изменения конфигурации**: Логирование обновлений наценок
- **Ошибки доступа**: Регистрация попыток несанкционированного использования
- **Системные исключения**: Детальная информация о технических проблемах

### Аналитика использования
- **Частота изменений**: Статистика активности администраторов
- **Популярные валютные пары**: Анализ наиболее часто настраиваемых пар
- **Паттерны ошибок**: Выявление типичных проблем пользователей
- **Производительность**: Мониторинг времени выполнения операций

## Развитие и масштабирование

### Планы расширения
- **Групповые операции**: Возможность изменения нескольких наценок одновременно
- **История изменений**: Ведение журнала модификаций с возможностью отката
- **Автоматические правила**: Динамическое изменение наценок на основе рыночных условий
- **Уведомления**: Информирование заинтересованных сторон об изменениях

### Интеграционные возможности
- **API интерфейс**: Программный доступ к функциям управления наценками
- **Внешние системы**: Синхронизация с торговыми платформами
- **Аналитические сервисы**: Экспорт данных для бизнес-анализа
- **Резервное копирование**: Автоматическое сохранение конфигураций

## Заключение

Команда `/set_markup` представляет собой критически важный инструмент для административного управления системой обмена валют. Реализация обеспечивает:

- **Безопасность**: Многоуровневая система контроля доступа
- **Надежность**: Комплексная валидация и обработка ошибок
- **Удобство**: Интуитивный пользовательский интерфейс
- **Производительность**: Быстрое выполнение операций
- **Качество**: Высокое покрытие тестами и соответствие стандартам

Функциональность полностью готова к использованию в производственной среде и служит основой для дальнейшего развития административного функционала системы.
