# TASK-011: –ö–æ–º–∞–Ω–¥–∞ /stats - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã –û–±–∑–æ—Ä –ó–∞–¥–∞—á–∏

**–ó–∞–¥–∞—á–∞**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã `/stats` –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 4 —á–∞—Å–∞
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**: 29 –¥–µ–∫–∞–±—Ä—è 2024

## üéØ –¶–µ–ª–∏ –∏ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –¶–µ–ª–∏
- –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–±–æ—Ä–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –∫–æ–º–∞–Ω–¥—É `/stats` —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- –û–±–µ—Å–ø–µ—á–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ñ–∞–π–ª –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- ‚úÖ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∑–∞–ø—Ä–æ—Å—ã, –æ—à–∏–±–∫–∏)
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—É—Å–ø–µ—à–Ω—ã–µ, –Ω–µ—É–¥–∞—á–Ω—ã–µ, –æ–±—ä–µ–º—ã)
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
- ‚úÖ –ê–¥–º–∏–Ω—Å–∫–∏–π –¥–æ—Å—Ç—É–ø —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –†–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°–∏—Å—Ç–µ–º—ã

```mermaid
graph TD
    A[AdminHandler /stats] --> B[AdminService]
    B --> C[StatsService]
    C --> D[CacheService]
    C --> E[Data Models]
    E --> F[UserStats]
    E --> G[TransactionStats]
    E --> H[ErrorStats]
    E --> I[SystemStats]
    E --> J[StatsAggregation]

    C --> K[Export Functions]
    C --> L[Cleanup Functions]
    C --> M[Analytics Functions]
```

### –ú–æ–¥–µ–ª–∏ –î–∞–Ω–Ω—ã—Ö

#### 1. UserStats
```python
class UserStats(BaseModel):
    user_id: int = Field(gt=0)
    username: str | None = None
    full_name: str | None = None
    first_seen: datetime
    last_seen: datetime
    total_requests: int = 0
    rate_requests: int = 0
    calc_requests: int = 0
    admin_commands: int = 0
    errors_encountered: int = 0
    favorite_pairs: dict[str, int] = Field(default_factory=dict)
    total_calculated_amount: Decimal = Field(default=Decimal("0"))
    is_active: bool = True
```

#### 2. TransactionStats
```python
class TransactionStats(BaseModel):
    transaction_id: str = Field(min_length=8)
    user_id: int = Field(gt=0)
    currency_pair: str
    input_amount: Decimal = Field(gt=0)
    output_amount: Decimal = Field(gt=0)
    market_rate: Decimal = Field(gt=0)
    final_rate: Decimal = Field(gt=0)
    markup_rate: Decimal = Field(ge=0)
    direction: Literal["buy", "sell"]
    timestamp: datetime = Field(default_factory=datetime.now)
    success: bool = True
```

#### 3. ErrorStats
```python
class ErrorStats(BaseModel):
    error_id: str
    error_type: str
    error_message: str
    user_id: int | None = None
    currency_pair: str | None = None
    timestamp: datetime = Field(default_factory=datetime.now)
    context: dict[str, Any] = Field(default_factory=dict)
```

#### 4. SystemStats
```python
class SystemStats(BaseModel):
    uptime_seconds: float
    total_users: int = 0
    active_users_today: int = 0
    active_users_week: int = 0
    total_requests: int = 0
    total_transactions: int = 0
    successful_transactions: int = 0
    total_errors: int = 0
    cache_hits: int = 0
    cache_misses: int = 0
    most_popular_pair: str | None = None
```

#### 5. StatsAggregation
```python
class StatsAggregation(BaseModel):
    period: str
    start_date: datetime
    end_date: datetime
    system_stats: SystemStats
    user_stats: dict[int, UserStats] = Field(default_factory=dict)
    transaction_stats: list[TransactionStats] = Field(default_factory=list)
    error_stats: list[ErrorStats] = Field(default_factory=list)
```

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. StatsService (`src/services/stats_service.py`)

#### –û—Å–Ω–æ–≤–Ω–æ–π –ö–ª–∞—Å—Å
```python
class StatsService:
    """Service for collecting and managing bot usage statistics."""

    def __init__(self, settings: Settings, cache_service: CacheService):
        self.settings = settings
        self.cache_service = cache_service
        self._user_stats: dict[int, UserStats] = {}
        self._transaction_stats: list[TransactionStats] = []
        self._error_stats: list[ErrorStats] = []
        self._start_time = datetime.now()
```

#### –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç–æ–¥—ã

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ó–∞–≥—Ä—É–∑–∫–∞ –î–∞–Ω–Ω—ã—Ö**
```python
async def initialize(self) -> None:
    """Initialize the stats service and load cached data."""

async def _load_from_cache(self) -> None:
    """Load statistics from cache storage."""
```

**–°–±–æ—Ä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
```python
async def record_user_activity(
    self,
    user_id: int,
    activity_type: StatsType,
    currency_pair: str | None = None,
    username: str | None = None,
    full_name: str | None = None
) -> None:
    """Record user activity statistics."""

async def record_transaction(
    self,
    transaction_id: str,
    user_id: int,
    currency_pair: str,
    input_amount: Decimal,
    output_amount: Decimal,
    market_rate: Decimal,
    final_rate: Decimal,
    markup_rate: Decimal,
    direction: Literal["buy", "sell"],
    success: bool = True,
) -> None:
    """Record transaction statistics."""

async def record_error(
    self,
    error_type: str,
    error_message: str,
    user_id: int | None = None,
    currency_pair: str | None = None,
    context: dict[str, Any] | None = None,
) -> None:
    """Record error statistics."""
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
```python
async def get_user_stats(self, user_id: int | None = None) -> dict[int, UserStats] | UserStats | None:
    """Get user statistics."""

async def get_system_stats(self) -> SystemStats:
    """Get system statistics."""

async def get_top_users(self, limit: int = 10) -> list[dict[str, Any]]:
    """Get top users by activity."""

async def get_currency_pair_stats(self) -> dict[str, dict[str, Any]]:
    """Get statistics by currency pairs."""
```

**–û—Ç—á–µ—Ç—ã –∏ –≠–∫—Å–ø–æ—Ä—Ç**
```python
async def generate_summary_report(self) -> dict[str, Any]:
    """Generate comprehensive summary report."""

async def export_stats_to_file(self, file_path: str) -> bool:
    """Export all statistics to JSON file."""
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã–º–∏**
```python
async def cleanup_old_data(self, days_to_keep: int = 30) -> int:
    """Clean up old statistics data."""

async def reset_stats(self, confirm_reset: bool = False) -> bool:
    """Reset all statistics data."""
```

### 2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### –ö–æ–º–∞–Ω–¥–∞ /stats
```python
@admin_router.message(Command("stats"))
async def cmd_stats(message: Message, settings: Settings) -> None:
    """Handle /stats command - show bot usage statistics."""

    # Check admin access
    if not await check_admin_access(message, settings):
        return

    try:
        admin_service = get_admin_service(settings)

        # Format statistics message
        stats_message = await admin_service.format_stats_message()

        # Create inline keyboard for export option
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [
                InlineKeyboardButton(text="üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª", callback_data="export_stats"),
                InlineKeyboardButton(text="üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh_stats")
            ],
            [
                InlineKeyboardButton(text="üóë –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", callback_data="clear_stats_confirm")
            ]
        ])

        await message.answer(stats_message, reply_markup=keyboard, parse_mode="HTML")
    except Exception as e:
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")
```

#### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```python
@admin_router.callback_query(F.data == "refresh_stats")
async def handle_refresh_stats(callback: CallbackQuery, settings: Settings) -> None:
    """Handle refresh stats button."""

@admin_router.callback_query(F.data == "export_stats")
async def handle_export_stats(callback: CallbackQuery, settings: Settings) -> None:
    """Handle export stats button."""

@admin_router.callback_query(F.data == "clear_stats_confirm")
async def handle_clear_stats_confirm(callback: CallbackQuery, settings: Settings) -> None:
    """Handle clear stats confirmation."""
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Main Application

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main.py
```python
async def create_dispatcher() -> Dispatcher:
    """Create and configure dispatcher with all routers."""
    settings = get_settings()
    dp = Dispatcher()

    # Create cache service for statistics
    try:
        cache_service = CacheServiceFactory.create_cache_service(settings)
        await cache_service.initialize()
        logging.info("‚úÖ Cache service initialized")

        # Create statistics service
        stats_service = StatsServiceFactory.create_stats_service(settings, cache_service)
        await stats_service.initialize()
        logging.info("‚úÖ Statistics service initialized")

        # Initialize admin service with statistics
        admin_service = get_admin_service(settings, stats_service)
        logging.info("‚úÖ Admin service initialized with statistics")

    except Exception as e:
        logging.warning(f"‚ö†Ô∏è Failed to initialize statistics service: {e}")
        logging.info("üìä Statistics features will be disabled")
```

#### –ö–æ–º–∞–Ω–¥—ã –ë–æ—Ç–∞
```python
async def setup_bot_commands(bot: Bot) -> None:
    """Setup bot commands for better UX."""
    commands = [
        BotCommand(command="start", description="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"),
        BotCommand(command="help", description="‚ùì –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"),
        BotCommand(command="rate", description="üí± –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—É—Ä—Å –≤–∞–ª—é—Ç"),
        BotCommand(command="calc", description="üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—É –æ–±–º–µ–Ω–∞"),
        BotCommand(command="set_markup", description="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É (–∞–¥–º–∏–Ω)"),
        BotCommand(command="set_manager", description="üë• –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–∞–¥–º–∏–Ω)"),
        BotCommand(command="stats", description="üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∞–¥–º–∏–Ω)"),
    ]
    await bot.set_my_commands(commands)
```

## üé® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –û—Å–Ω–æ–≤–Ω–æ–µ –°–æ–æ–±—â–µ–Ω–∏–µ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```
üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞**

üñ• **–°–∏—Å—Ç–µ–º–∞**
‚è± –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: `X –¥–Ω–µ–π`
üë§ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: `X`
üî• –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è: `X`
üìÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: `X`

üí± **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
üìà –í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: `X`
‚úÖ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: `X%`
‚ùå –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: `X`
üìä –ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫: `X%`

‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
üíæ –ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫–µ—à: `X%`
üèÜ –ü–æ–ø—É–ª—è—Ä–Ω–∞—è –ø–∞—Ä–∞: `USD/RUB`

üëë **–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**
1. @username: `X` –∑–∞–ø—Ä–æ—Å–æ–≤
2. User 123: `X` –∑–∞–ø—Ä–æ—Å–æ–≤
...

üí∞ **–í–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ä—ã**
‚Ä¢ **USD/RUB**: `X` –∑–∞–ø—Ä–æ—Å–æ–≤, `X` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ **EUR/USD**: `X` –∑–∞–ø—Ä–æ—Å–æ–≤, `X` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
...

_üì§ –î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ_
```

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –ö–Ω–æ–ø–∫–∏
- **üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª** - –°–æ–∑–¥–∞–µ—Ç JSON —Ñ–∞–π–ª —Å–æ –≤—Å–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- **üîÑ –û–±–Ω–æ–≤–∏—Ç—å** - –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- **üóë –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É** - –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)

### –î–∏–∞–ª–æ–≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –û—á–∏—Å—Ç–∫–∏
```
‚ö†Ô∏è **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**

–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞?

**–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!**
–ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
‚Ä¢ –ñ—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫
‚Ä¢ –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

_–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∞—á–∞–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É_

[‚ö†Ô∏è –î–ê, –û–ß–ò–°–¢–ò–¢–¨] [‚ùå –û—Ç–º–µ–Ω–∞]
```

## üì§ –≠–∫—Å–ø–æ—Ä—Ç –î–∞–Ω–Ω—ã—Ö

### –§–æ—Ä–º–∞—Ç JSON –≠–∫—Å–ø–æ—Ä—Ç–∞
```json
{
  "export_info": {
    "timestamp": "2024-12-29T14:30:00Z",
    "version": "1.0.0",
    "total_users": 150,
    "total_transactions": 1250,
    "total_errors": 23
  },
  "system_stats": {
    "uptime_seconds": 86400.0,
    "total_users": 150,
    "active_users_today": 45,
    "active_users_week": 89,
    "total_requests": 2500,
    "total_transactions": 1250,
    "successful_transactions": 1227,
    "total_errors": 23,
    "cache_hits": 2100,
    "cache_misses": 400,
    "most_popular_pair": "USD/RUB"
  },
  "user_stats": {
    "123456789": {
      "user_id": 123456789,
      "username": "john_doe",
      "full_name": "John Doe",
      "first_seen": "2024-12-01T10:00:00Z",
      "last_seen": "2024-12-29T14:25:00Z",
      "total_requests": 45,
      "rate_requests": 20,
      "calc_requests": 25,
      "admin_commands": 0,
      "errors_encountered": 1,
      "favorite_pairs": {"USD/RUB": 30, "EUR/USD": 15},
      "total_calculated_amount": "15000.00",
      "is_active": true
    }
  },
  "transaction_stats": [...],
  "error_stats": [...],
  "currency_pair_stats": {...}
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤ (`tests/unit/services/test_stats_service.py`)

#### 1. –¢–µ—Å—Ç—ã –ú–æ–¥–µ–ª–µ–π –î–∞–Ω–Ω—ã—Ö (11 —Ç–µ—Å—Ç–æ–≤)
```python
class TestUserStats:
    def test_user_stats_creation(self)
    def test_user_stats_properties(self)
    def test_user_stats_most_used_pair(self)
    def test_update_activity(self)

class TestTransactionStats:
    def test_transaction_stats_creation(self)
    def test_transaction_stats_properties(self)

class TestErrorStats:
    def test_error_stats_creation(self)

class TestSystemStats:
    def test_system_stats_creation(self)
    def test_system_stats_properties(self)

class TestStatsAggregation:
    def test_stats_aggregation_creation(self)
    def test_stats_aggregation_properties(self)
```

#### 2. –¢–µ—Å—Ç—ã StatsService (21 —Ç–µ—Å—Ç)
```python
class TestStatsService:
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    def test_service_initialization(self)
    def test_initialize_service(self)
    def test_initialize_service_cache_failure(self)

    # –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö
    def test_record_user_activity(self)
    def test_record_user_activity_error(self)
    def test_record_transaction(self)
    def test_record_transaction_failed(self)
    def test_record_error(self)

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    def test_get_user_stats(self)
    def test_get_system_stats(self)
    def test_get_top_users(self)
    def test_get_recent_transactions(self)
    def test_get_recent_errors(self)
    def test_get_currency_pair_stats(self)

    # –û—Ç—á–µ—Ç—ã –∏ —ç–∫—Å–ø–æ—Ä—Ç
    def test_generate_summary_report(self)
    def test_export_stats_to_file(self)
    def test_export_stats_to_file_error(self)

    # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
    def test_reset_stats(self)
    def test_cleanup_old_data(self)
    def test_cleanup_old_data_error(self)
```

#### 3. –¢–µ—Å—Ç—ã Factory –∏ Exceptions (3 —Ç–µ—Å—Ç–∞)
```python
class TestStatsServiceFactory:
    def test_create_stats_service(self)

class TestStatsException:
    def test_stats_exception_creation(self)
    def test_stats_exception_defaults(self)

class TestStatsType:
    def test_stats_type_values(self)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
$ python -m pytest tests/unit/services/test_stats_service.py -v
================================= test session starts =================================
collected 35 items

tests/unit/services/test_stats_service.py::TestUserStats::test_user_stats_creation PASSED
tests/unit/services/test_stats_service.py::TestUserStats::test_user_stats_properties PASSED
...
tests/unit/services/test_stats_service.py::TestStatsType::test_stats_type_values PASSED

============================== 35 passed, 1 warning in 0.28s ==============================
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ö–æ–Ω—Ç—Ä–æ–ª—å –î–æ—Å—Ç—É–ø–∞
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤**: –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ `admin_user_ids` –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: Pydantic –º–æ–¥–µ–ª–∏ —Å —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞**: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: Graceful handling –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –î–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è**: –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis —Å TTL

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –í—Å–µ –º–µ—Ç–æ–¥—ã async/await
- ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Redis –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- ‚úÖ **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Lazy loading**: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

### –ú–µ—Ç—Ä–∏–∫–∏
- ‚úÖ **Cache hit rate**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–µ—à–∞
- ‚úÖ **Response time**: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞
- ‚úÖ **Memory usage**: –ö–æ–Ω—Ç—Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
- ‚úÖ **Error rate**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ—à–∏–±–æ–∫

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```python
# settings.py
class Settings(BaseSettings):
    # Statistics settings
    stats_enabled: bool = True
    stats_cache_ttl: int = 3600  # 1 hour
    stats_cleanup_days: int = 30
    stats_max_users: int = 10000
    stats_max_transactions: int = 100000
```

### Docker Environment
```yaml
# docker-compose.yml
services:
  crypto-bot:
    environment:
      - STATS_ENABLED=true
      - STATS_CACHE_TTL=3600
      - STATS_CLEANUP_DAYS=30
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**
   - –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –¥–µ–Ω—å
   - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—è/–º–µ—Å—è—Ü)
   - –°—Ä–µ–¥–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**
   - –û–±—â–∏–π –æ–±—ä–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
   - –£—Å–ø–µ—à–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (%)
   - –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

3. **–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏**
   - –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∞ (hit rate)
   - –ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫

4. **–ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞**
   - –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞–ª—é—Ç–Ω—ã–µ –ø–∞—Ä—ã
   - –ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   - –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –î—Ä—É–≥–∏–º–∏ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∫–æ–º–∞–Ω–¥
async def handle_rate_request(message: Message):
    # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
    await process_rate_request(message)

    # –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    if stats_service:
        await stats_service.record_user_activity(
            user_id=message.from_user.id,
            activity_type=StatsType.RATE_REQUEST,
            currency_pair=selected_pair,
            username=message.from_user.username,
            full_name=message.from_user.full_name
        )
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Notification Service
```python
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö
if error_rate > 10:  # –ï—Å–ª–∏ —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ > 10%
    await notification_service.send_admin_alert(
        message="üö® –í—ã—Å–æ–∫–∞—è —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫: {error_rate}%",
        priority="high"
    )
```

## üìà –ë—É–¥—É—â–∏–µ –£–ª—É—á—à–µ–Ω–∏—è

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –§—É–Ω–∫—Ü–∏–∏
1. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
   - –¢—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã
   - –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**
   - –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã
   - Dashboard –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
   - Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

3. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã
   - –ê–ª–µ—Ä—Ç—ã –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º
   - –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**
   - –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Analytics
   - Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

TASK-011 —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º comprehensive —Å–∏—Å—Ç–µ–º—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –∫–æ—Ç–æ—Ä–∞—è:

- ‚úÖ **–°–æ–±–∏—Ä–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É** –ø–æ –≤—Å–µ–º –∞—Å–ø–µ–∫—Ç–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞
- ‚úÖ **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- ‚úÖ **–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞** —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞** —Å 35 unit —Ç–µ—Å—Ç–∞–º–∏
- ‚úÖ **–ì–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π.

---

**–ê–≤—Ç–æ—Ä**: AI Assistant
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 29 –¥–µ–∫–∞–±—Ä—è 2024
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0
**–°—Ç–∞—Ç—É—Å**: –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
