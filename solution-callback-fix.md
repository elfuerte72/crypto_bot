# üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ Callback-–∫–Ω–æ–ø–∫–∞–º–∏

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
–ö–Ω–æ–ø–∫–∞ "üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å" –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å –±–æ—Ç–æ–º. –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
Update id=212159511 is not handled. Duration 5 ms
```

## üîç –ü—Ä–∏—á–∏–Ω–∞
–í —Ñ–∞–π–ª–µ `src/bot/handlers/calc_handler.py` –±—ã–ª–æ **–¥–≤–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ `callback_data = "start_calculation"`:

1. **–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫** (—Å—Ç—Ä–æ–∫–∞ 378) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM:
```python
@calc_router.callback_query(CalcStates.showing_rate, F.data == "start_calculation")
async def handle_start_calculation(callback: CallbackQuery, state: FSMContext, settings: Settings)
```

2. **–¢–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫** (—Å—Ç—Ä–æ–∫–∞ 728) - –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª –í–°–ï callback –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
```python
@calc_router.callback_query(F.data == "start_calculation")  # –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è!
async def handle_start_calculation_simple(callback: CallbackQuery, state: FSMContext)
```

–í—Ç–æ—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª callback –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–≥ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ
–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
```python
# Simple test handler for start_calculation - DISABLED to avoid conflict
# @calc_router.callback_query(F.data == "start_calculation")
# async def handle_start_calculation_simple(...):
#     ...
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å" —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–≤–µ—Å—Ç–∏ —Å—É–º–º—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
- ‚úÖ Callback –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üí° –í—ã–≤–æ–¥—ã
1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - –æ—Å–æ–±–µ–Ω–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã–µ
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM** –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
3. **–£–¥–∞–ª—è–π—Ç–µ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥** –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç** –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É

## üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python main.py

# –í Telegram:
1. /calc - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
2. –í—ã–±—Ä–∞—Ç—å –≤–∞–ª—é—Ç–Ω—É—é –ø–∞—Ä—É
3. –ù–∞–∂–∞—Ç—å "üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å" - —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!
4. –í–≤–µ—Å—Ç–∏ —Å—É–º–º—É
5. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞
```

## üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
–í —Ñ–∞–π–ª–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:
- `asyncio`
- `StorageKey`
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ `calculation_service`

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –æ–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ `handle_unhandled_callback` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 738 –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –¥–ª—è –ª—É—á—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
```python
@calc_router.callback_query()
async def handle_unhandled_callback(callback: CallbackQuery, state: FSMContext) -> None:
    """Handle unhandled callback queries for debugging."""
    current_state = await state.get_state()
    logger.warning(
        f"Unhandled callback: data='{callback.data}', "
        f"user={callback.from_user.id}, current_state={current_state}"
    )
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if callback.data == "start_calculation" and current_state != CalcStates.showing_rate:
        await callback.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç–Ω—É—é –ø–∞—Ä—É", show_alert=True)
    else:
        await callback.answer("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞", show_alert=True)
```
